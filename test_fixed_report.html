<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拼图游戏稳定性测试 - 修复测试页面</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-primary {
            background-color: #2196F3;
        }
        .btn-primary:hover {
            background-color: #0b7dda;
        }
        .btn-danger {
            background-color: #f44336;
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #c62828;
        }
        .success-message {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #2e7d32;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }
        #report-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        /* 报告样式 */
        .report-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .chart-container {
            margin-bottom: 30px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        canvas {
            max-width: 100%;
            height: auto !important;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .download-link {
            display: inline-block;
            background-color: #2196F3;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 15px;
        }
        .download-link:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>拼图游戏稳定性测试 - 修复测试页面</h1>
        
        <div class="test-section">
            <h2>测试工具</h2>
            <p>这个页面包含了修复后的<code>generateHTMLReport</code>函数和模拟测试数据，可以直接验证修复效果。</p>
            <button id="run-test" class="btn btn-primary">运行测试</button>
            <button id="view-code" class="btn">查看源代码</button>
            <button id="clear-report" class="btn btn-danger">清除报告</button>
        </div>
        
        <div id="status-message" style="display: none;"></div>
        
        <div id="report-container" style="display: none;">
            <h2>测试报告</h2>
            <div id="report-content"></div>
        </div>
        
        <div id="code-container" style="display: none;">
            <h2>源代码</h2>
            <pre id="source-code"></pre>
        </div>
    </div>

    <script>
        // 重写console.log和console.error以捕获输出
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        console.log = function() {
            const message = Array.from(arguments).join(' ');
            originalConsoleLog.apply(console, arguments);
            
            // 在页面上显示日志
            if (document.getElementById('debug-log')) {
                const logElement = document.createElement('div');
                logElement.textContent = message;
                document.getElementById('debug-log').appendChild(logElement);
            }
        };
        
        console.error = function() {
            const message = Array.from(arguments).join(' ');
            originalConsoleError.apply(console, arguments);
            
            // 在页面上显示错误
            showMessage(message, 'error');
        };
        
        // 显示状态消息
        function showMessage(message, type = 'info') {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = type === 'error' ? 'error-message' : 'success-message';
            statusElement.style.display = 'block';
            
            // 5秒后自动隐藏非错误消息
            if (type !== 'error') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }
        
        // 生成模拟测试数据
        function generateMockTestResults() {
            return {
                startTime: new Date(Date.now() - 3600000).toISOString(),
                endTime: new Date().toISOString(),
                totalDuration: 3600,
                totalGames: 50,
                avgTime: 1200,
                errorCount: 3,
                crashDetected: false,
                performanceMetrics: Array.from({length: 10}, (_, i) => ({
                    gameCount: i * 5 + 5,
                    avgTime: 1200 + Math.random() * 200 - 100,
                    errorCount: Math.floor(Math.random() * 2)
                })),
                difficultyStats: {
                    easy: { totalGames: 20, successRate: 98, avgTime: 800 },
                    medium: { totalGames: 15, successRate: 92, avgTime: 1200 },
                    hard: { totalGames: 10, successRate: 85, avgTime: 1800 },
                    expert: { totalGames: 5, successRate: 75, avgTime: 2500 }
                },
                memorySnapshots: Array.from({length: 12}, (_, i) => ({
                    timestamp: i * 300000,
                    usedJSHeapSize: 100000000 + i * 10000000 + Math.random() * 5000000
                }))
            };
        }
        
        // 核心函数：生成HTML报告
        function generateHTMLReport(testResults) {
            try {
                // 合并默认数据和实际数据，确保即使缺少某些字段也能正常工作
                const defaultResults = {
                    startTime: new Date().toISOString(),
                    endTime: new Date().toISOString(),
                    totalDuration: 0,
                    totalGames: 0,
                    avgTime: 0,
                    errorCount: 0,
                    crashDetected: false,
                    performanceMetrics: [],
                    difficultyStats: {},
                    memorySnapshots: []
                };
                
                // 合并结果
                const mergedResults = { ...defaultResults, ...testResults };
                
                // 确保嵌套对象也被合并
                mergedResults.difficultyStats = {
                    easy: { totalGames: 0, successRate: 0, avgTime: 0 },
                    medium: { totalGames: 0, successRate: 0, avgTime: 0 },
                    hard: { totalGames: 0, successRate: 0, avgTime: 0 },
                    expert: { totalGames: 0, successRate: 0, avgTime: 0 },
                    ...mergedResults.difficultyStats
                };
                
                // 安全处理JSON字符串，避免单引号问题
                const safeResultsString = JSON.stringify(mergedResults).replace(/'/g, "\\'");
                
                console.log('生成HTML报告，测试结果数据:', mergedResults);
                
                // 计算错误率
                const errorRate = mergedResults.totalGames > 0 
                    ? ((mergedResults.errorCount / mergedResults.totalGames) * 100).toFixed(2) 
                    : '0.00';
                
                // 格式化时间
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                };
                
                // 生成报告HTML内容
                let reportHTML = `
                <div class="report-header">
                    <h1>拼图游戏稳定性测试报告</h1>
                    <p>测试时间: ${formatDate(mergedResults.startTime)} - ${formatDate(mergedResults.endTime)}</p>
                    <p>测试持续时间: ${(mergedResults.totalDuration / 60).toFixed(2)} 分钟</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${mergedResults.totalGames}</div>
                        <div class="metric-label">总游戏局数</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(mergedResults.avgTime / 1000).toFixed(2)}s</div>
                        <div class="metric-label">平均耗时</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${mergedResults.errorCount}</div>
                        <div class="metric-label">错误总数</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${errorRate}%</div>
                        <div class="metric-label">错误率</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${mergedResults.crashDetected ? '是' : '否'}</div>
                        <div class="metric-label">崩溃检测</div>
                    </div>
                </div>
                `;
                
                // 添加性能趋势图
                reportHTML += `
                <div class="chart-container">
                    <h3>性能趋势图</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
                `;
                
                // 添加难度对比图
                reportHTML += `
                <div class="chart-container">
                    <h3>难度对比图</h3>
                    <canvas id="difficultyChart"></canvas>
                </div>
                `;
                
                // 添加内存使用趋势图
                reportHTML += `
                <div class="chart-container">
                    <h3>内存使用趋势图</h3>
                    <canvas id="memoryChart"></canvas>
                </div>
                `;
                
                // 添加详细测试结果表格
                reportHTML += `
                <h3>详细测试结果</h3>
                <table>
                    <tr>
                        <th>指标</th>
                        <th>值</th>
                    </tr>
                    <tr>
                        <td>测试开始时间</td>
                        <td>${formatDate(mergedResults.startTime)}</td>
                    </tr>
                    <tr>
                        <td>测试结束时间</td>
                        <td>${formatDate(mergedResults.endTime)}</td>
                    </tr>
                    <tr>
                        <td>测试持续时间</td>
                        <td>${(mergedResults.totalDuration / 60).toFixed(2)} 分钟</td>
                    </tr>
                    <tr>
                        <td>总游戏局数</td>
                        <td>${mergedResults.totalGames}</td>
                    </tr>
                    <tr>
                        <td>平均每局耗时</td>
                        <td>${(mergedResults.avgTime / 1000).toFixed(2)} 秒</td>
                    </tr>
                    <tr>
                        <td>错误总数</td>
                        <td>${mergedResults.errorCount}</td>
                    </tr>
                    <tr>
                        <td>错误率</td>
                        <td>${errorRate}%</td>
                    </tr>
                    <tr>
                        <td>是否检测到崩溃</td>
                        <td>${mergedResults.crashDetected ? '是' : '否'}</td>
                    </tr>
                </table>
                `;
                
                // 显示报告
                const reportContainer = document.getElementById('report-container');
                const reportContent = document.getElementById('report-content');
                
                reportContent.innerHTML = reportHTML;
                reportContainer.style.display = 'block';
                
                // 渲染图表
                renderCharts(mergedResults);
                
                showMessage('测试报告生成成功！', 'success');
                console.log('测试报告生成成功');
                
            } catch (error) {
                console.error('生成报告时出错:', error);
                showMessage('生成报告时出错: ' + error.message, 'error');
            }
        }
        
        // 渲染图表
        function renderCharts(mergedResults) {
            try {
                // 性能趋势图
                try {
                    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
                    if (performanceCtx && mergedResults.performanceMetrics && mergedResults.performanceMetrics.length > 0) {
                        new Chart(performanceCtx, {
                            type: 'line',
                            data: {
                                labels: mergedResults.performanceMetrics.map(item => item.gameCount),
                                datasets: [
                                    {
                                        label: '平均耗时(ms)',
                                        data: mergedResults.performanceMetrics.map(item => item.avgTime),
                                        borderColor: 'rgb(75, 192, 192)',
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: '错误数量',
                                        data: mergedResults.performanceMetrics.map(item => item.errorCount),
                                        borderColor: 'rgb(255, 99, 132)',
                                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: '耗时(ms)'
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: '错误数量'
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (chartError) {
                    console.error('性能趋势图渲染失败:', chartError);
                }
                
                // 难度对比图
                try {
                    const difficultyCtx = document.getElementById('difficultyChart').getContext('2d');
                    const difficulties = Object.keys(mergedResults.difficultyStats);
                    
                    if (difficultyCtx && difficulties.length > 0) {
                        new Chart(difficultyCtx, {
                            type: 'bar',
                            data: {
                                labels: difficulties.map(d => d.charAt(0).toUpperCase() + d.slice(1)),
                                datasets: [
                                    {
                                        label: '游戏局数',
                                        data: difficulties.map(d => mergedResults.difficultyStats[d].totalGames),
                                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                        borderColor: 'rgb(54, 162, 235)',
                                        borderWidth: 1,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: '成功率(%)',
                                        data: difficulties.map(d => mergedResults.difficultyStats[d].successRate),
                                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                        borderColor: 'rgb(75, 192, 192)',
                                        borderWidth: 1,
                                        type: 'line',
                                        yAxisID: 'y1'
                                    },
                                    {
                                        label: '平均耗时(ms)',
                                        data: difficulties.map(d => mergedResults.difficultyStats[d].avgTime),
                                        backgroundColor: 'rgba(255, 206, 86, 0.5)',
                                        borderColor: 'rgb(255, 206, 86)',
                                        borderWidth: 1,
                                        type: 'line',
                                        yAxisID: 'y2'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: '游戏局数'
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: '成功率(%)'
                                        },
                                        min: 0,
                                        max: 100,
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    },
                                    y2: {
                                        type: 'linear',
                                        display: false,
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (chartError) {
                    console.error('难度对比图渲染失败:', chartError);
                }
                
                // 内存使用趋势图
                try {
                    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
                    
                    if (memoryCtx && mergedResults.memorySnapshots && mergedResults.memorySnapshots.length > 0) {
                        // 将内存使用量转换为MB
                        const memoryData = mergedResults.memorySnapshots.map(snapshot => ({
                            timestamp: new Date(snapshot.timestamp).toLocaleTimeString(),
                            usedJSHeapSize: snapshot.usedJSHeapSize / (1024 * 1024)
                        }));
                        
                        new Chart(memoryCtx, {
                            type: 'line',
                            data: {
                                labels: memoryData.map(item => item.timestamp),
                                datasets: [
                                    {
                                        label: '内存使用量(MB)',
                                        data: memoryData.map(item => item.usedJSHeapSize),
                                        borderColor: 'rgb(153, 102, 255)',
                                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                        fill: true,
                                        tension: 0.1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        title: {
                                            display: true,
                                            text: '内存使用量(MB)'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: '时间'
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (chartError) {
                    console.error('内存使用趋势图渲染失败:', chartError);
                }
                
            } catch (error) {
                console.error('渲染图表时出错:', error);
            }
        }
        
        // 事件监听器
        document.getElementById('run-test').addEventListener('click', function() {
            try {
                // 生成模拟数据
                const mockResults = generateMockTestResults();
                
                // 调用修复后的函数
                generateHTMLReport(mockResults);
                
            } catch (error) {
                console.error('测试执行失败:', error);
                showMessage('测试执行失败: ' + error.message, 'error');
            }
        });
        
        document.getElementById('view-code').addEventListener('click', function() {
            const codeContainer = document.getElementById('code-container');
            const sourceCode = document.getElementById('source-code');
            
            if (codeContainer.style.display === 'none') {
                // 获取generateHTMLReport函数的源代码
                sourceCode.textContent = generateHTMLReport.toString();
                codeContainer.style.display = 'block';
                this.textContent = '隐藏源代码';
            } else {
                codeContainer.style.display = 'none';
                this.textContent = '查看源代码';
            }
        });
        
        document.getElementById('clear-report').addEventListener('click', function() {
            const reportContainer = document.getElementById('report-container');
            const reportContent = document.getElementById('report-content');
            const statusMessage = document.getElementById('status-message');
            
            reportContent.innerHTML = '';
            reportContainer.style.display = 'none';
            statusMessage.style.display = 'none';
            showMessage('报告已清除', 'success');
        });
        
        // 初始化时显示欢迎信息
        window.onload = function() {
            showMessage('页面加载完成，请点击"运行测试"按钮开始测试', 'success');
        };
    </script>
</body>
</html>